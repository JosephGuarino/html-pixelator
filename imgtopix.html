<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Pixelator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    #controls {
      margin-bottom: 10px;
      text-align: center;
    }
    #canvasContainer {
      border: 1px solid #000;
      margin-top: 20px;
      max-width: 100%;
      max-height: 400px;
      overflow: auto;
    }
    canvas {
      width: 100%;
      height: auto;
      max-width: 100%;
    }
    label {
      margin-right: 10px;
    }
    input[type="number"] {
      width: 60px;
    }
  </style>
</head>
<body>
  <h1>Image Pixelator</h1>
  <div id="controls">
    <input type="file" id="imageInput" accept="image/*"><br><br>

    <label for="pixelSize">Pixel Size:</label>
    <input type="number" id="pixelSize" value="10" min="1" max="100"> px<br><br>

    <label for="widthInput">Width:</label>
    <input type="number" id="widthInput" placeholder="Enter width"><br><br>

    <label for="heightInput">Height:</label>
    <input type="number" id="heightInput" placeholder="Enter height"><br><br>

    <label for="transparentBg">
      <input type="checkbox" id="transparentBg"> Keep background transparent
    </label><br><br>

    <button id="convertBtn">Pixelate</button><br><br>
    <button id="saveBtn" style="display:none;">Save Image</button>
  </div>

  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const pixelSizeInput = document.getElementById('pixelSize');
    const widthInput = document.getElementById('widthInput');
    const heightInput = document.getElementById('heightInput');
    const transparentBgCheckbox = document.getElementById('transparentBg');
    const convertBtn = document.getElementById('convertBtn');
    const saveBtn = document.getElementById('saveBtn');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let image = new Image();

    // Load selected image
    imageInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          image.src = e.target.result;
          image.onload = function() {
            // Set initial canvas size to the original image size
            const aspectRatio = image.width / image.height;
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
          };
        };
        reader.readAsDataURL(file);
      }
    });

    // Pixelator
    convertBtn.addEventListener('click', () => {
      const pixelSize = parseInt(pixelSizeInput.value);
      const targetWidth = parseInt(widthInput.value) || image.width;
      const targetHeight = parseInt(heightInput.value) || image.height;
      const keepTransparent = transparentBgCheckbox.checked;

      // Resize canvas to user-specified resolution or default to image size
      canvas.width = targetWidth;
      canvas.height = targetHeight;

      // Resize the image to the new resolution
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;

      // Pixelate the image
      for (let y = 0; y < canvas.height; y += pixelSize) {
        for (let x = 0; x < canvas.width; x += pixelSize) {
          let red = 0, green = 0, blue = 0, alpha = 0, count = 0;

          // Get average color of the pixel block
          for (let yy = 0; yy < pixelSize; yy++) {
            for (let xx = 0; xx < pixelSize; xx++) {
              const pixelX = x + xx;
              const pixelY = y + yy;
              if (pixelX < canvas.width && pixelY < canvas.height) {
                const index = (pixelY * canvas.width + pixelX) * 4;
                red += data[index];
                green += data[index + 1];
                blue += data[index + 2];
                alpha += data[index + 3];
                count++;
              }
            }
          }

          red = Math.floor(red / count);
          green = Math.floor(green / count);
          blue = Math.floor(blue / count);
          alpha = Math.floor(alpha / count);

          // If transparency is kept and alpha is low, leave the area transparent
          if (keepTransparent && alpha < 128) {
            ctx.clearRect(x, y, pixelSize, pixelSize);
          } else {
            ctx.fillStyle = `rgba(${red}, ${green}, ${blue}, ${alpha / 255})`;
            ctx.fillRect(x, y, pixelSize, pixelSize);
          }
        }
      }

      // Show the save button after conversion
      saveBtn.style.display = 'inline';
    });

    // Save image as a PNG
    saveBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = 'pixelated-image.png';
      link.click();
    });
  </script>
</body>
</html>
